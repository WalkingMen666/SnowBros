# 2025 OOPL Final Report

## 組別資訊

組別：P03  
組員：112590021 張家程、112590055 彭瑜祐
復刻遊戲：Snow Bros

## 專案簡介

### 遊戲簡介

Snow Bros 是一款經典的街機遊戲，玩家操作雪人兄弟 Nick 和 Tom，通過投擲雪球將敵人凍結並擊敗，目標是清除每關的所有敵人。遊戲以其簡單的操作、豐富的關卡設計和有趣的美術風格深受玩家喜愛。我們的專案旨在使用物件導向程式設計（OOP）原則，復刻這款遊戲的核心玩法，並加入現代化的程式設計技術來提升遊戲體驗。

### 組別分工

-   **張家程**：

    -   遊戲地圖編碼
    -   部分地圖架構與邏輯
    -   部分 UI 介面
    -   Boss1 架構與邏輯
    -   Boss2 架構與邏輯
    -   場景切換系統
    -   掉落物架構與邏輯
    -   難易度調整

-   **彭瑜祐**：
    -   前期素材整理
    -   主角(Nick)架構與邏輯
    -   紅惡魔(RedDemon)架構與邏輯
    -   猴子(Monkey)架構與邏輯
    -   青蛙(Frog)架構與邏輯
    -   相撲(Fat)架構與邏輯
    -   統一物件管理系統
    -   部分地圖架構與邏輯
    -   部分 UI 介面
    -   遊戲開始結束畫面

## 遊戲介紹

### 遊戲規則

1. **目標**：玩家控制雪人兄弟，通過投擲雪球將敵人包覆成雪球，並推動雪球消滅敵人以清空關卡。
2. **操作**：使用 WASD 鍵移動、空白鍵跳躍、滑鼠左鍵投擲雪球。雪球擊中敵人也會將其變成雪球，且可推動、踩踏，靠近左鍵可以踢出，踢出的雪球可擊敗敵人獲得掉落物獎勵。
3. **關卡**：遊戲包含 20 個關卡，每關敵人數量不一，每 10 關有 Boss 戰。
4. **死亡條件**：玩家被敵人觸碰或是被火球擊中則損失一條生命，生命耗盡則遊戲結束。
5. **Debug 模式**：
    - `I` 鍵可切換無敵模式，無敵模式主角會閃爍
    - `N` 鍵可跳躍至下一關
    - `H` 鍵可增加主角血量，上限為 9

### 遊戲畫面

遊戲畫面採用 2D 像素風格，重現原版 Snow Bros 的復古美術。  
![遊戲初始畫面](https://i.ibb.co/vxYH6Xb6/Screenshot-2025-06-13-145307.png)
![第一關畫面](https://i.ibb.co/4Zhc62py/Screenshot-2025-06-13-145325.png)
![Boss1畫面](https://i.ibb.co/wNnjQwL7/Screenshot-2025-06-13-145343.png)
![Boss2畫面](https://i.ibb.co/NnZ8rmBL/Screenshot-2025-06-13-145410.png)

## 程式設計

### 程式架構

整體架構基於物件導向程式設計（OOP）原則，將遊戲元素抽象化為模組化的類別，實現高效、可維護的程式碼。核心類別與系統如下：

1. **遊戲管理器 (App)**：

    - 作為遊戲的核心控制單元，負責主循環、事件處理、狀態切換（初始畫面、遊戲中、遊戲結束）以及資源初始化（如背景音樂與 UI 圖片快取）。
    - 採用單例模式確保全局資源的唯一性，協調各子系統（如玩家、敵人、地圖）的運作。
    - 管理物件的創建與銷毀，透過 GameWorld 維護動態物件集合。

2. **玩家 (Nick)**：

    - 表示玩家角色，負責移動、跳躍、投擲雪球、推動與踢雪球等行為。
    - 使用狀態機管理行為，包括靜止（IDLE）、走路（WALK）、攻擊（ATTACK）、跳躍（JUMP）、下落（FALL）、死亡（DIE）、推動（PUSH）與踢（KICK）。每個狀態對應特定動畫與邏輯，確保行為流暢。
    - 支援無敵模式與動畫閃爍效果，透過回呼機制處理碰撞與死亡事件。

3. **敵人 (Enemy)**：

    - 基類定義敵人共用行為（如移動、碰撞、被擊中），衍生類（如 RedDemon、Frog、Monkey、Fat、Boss）實現不同 AI 與特性。
    - 採用狀態機管理行為（站立、行走、跳躍、下落、死亡），並在被雪球擊中後轉為雪球狀態（Snowball），由獨立的 Snowball 物件管理。
    - Boss 類具有獨特的跳躍與生成小怪邏輯，增加關卡挑戰性。

4. **雪球 (Snowball)**：

    - 管理雪球的生成、移動、碰撞與融化邏輯，與敵人存在一對一關係。
    - 雪球狀態機包含靜止（Static）、被推（Pushed）、被踢（Kicked）與銷毀（Killed），支援滾動碰撞與融化計時。
    - 當敵人進入雪球狀態時，敵人隱藏並同步位置至雪球，雪球銷毀或融化後觸發敵人恢復或移除。

5. **關卡 (PhaseResourceManager)**：

    - 負責關卡初始化、敵人生成與地圖載入，儲存敵人類型與位置的配置表。
    - 使用 Factory Pattern 動態生成敵人實例，支援靈活的關卡設計。

6. **地圖 (Map)**：

    - 管理地圖資料與碰撞檢測，地圖以 5 像素為單位分割為網格，編碼為 0（空）、1（可穿越平台）、2（牆壁）、3（不可穿越平台）。
    - 提供高效的網格查詢介面，支援玩家與敵人的碰撞計算。

7. **遊戲世界 (GameWorld)**：

    - 統一管理所有動態物件（玩家、敵人、雪球、子彈），提供添加、移除與更新功能。
    - 透過物件池設計簡化生命週期管理，提升效能並確保邏輯一致性。

8. **使用者介面 (UI)**：

    - 負責渲染分數、生命值與 debug 資訊（如 FPS、物件座標、碰撞框）。
    - 使用圖片快取動態更新 UI 元素，確保高效渲染。

9. **物理系統**：

    - 實現 2D 物理模擬，包括重力、跳躍速度與碰撞處理。
    - 與地圖和雪球的碰撞檢測整合，計算角色運動軌跡並修正位置。

10. **碰撞系統**：
    - 使用 AABB（Axis-Aligned Bounding Box）演算法檢測物件碰撞，支援玩家與敵人、雪球與敵人、子彈與物件等多種交互。
    - 採用空間分割技術優化效率，僅檢查角色附近的網格圖塊。

**系統設計亮點**：

-   **狀態機**：玩家、敵人與雪球的行為透過有限狀態機（FSM）管理，將邏輯分解為獨立狀態，簡化複雜行為的實現。
-   **Factory Pattern**：敵人生成採用工廠模式，根據配置表動態創建不同敵人，增強關卡設計的靈活性。
-   **雪球與敵人關係**：雪球作為獨立物件管理敵人被凍結的狀態，透過一對一關聯實現模組化邏輯。
-   **統一物件管理**：GameWorld 作為物件池，集中管理動態物件，降低耦合並提升效能。

### 程式技術

1. **狀態機 (Finite State Machine)**：

    - 玩家、敵人與雪球採用狀態機管理行為，每個狀態定義輸入處理、動畫播放與轉換規則。例如，玩家在跳躍狀態檢測落地後轉為靜止或走路；雪球在被踢後進入滾動狀態並檢測碰撞。狀態機提高程式碼模組化與可維護性。

2. **物理系統**：

    - 實現 2D 物理模擬，包含重力、跳躍初速度與速度衰減。移動與跳躍透過時間步長（deltaTime）計算位移，確保平滑運動。
    - GameWorld 的 map_collision_judgement 函數整合物理與碰撞，修正角色位置與速度。

3. **地圖編碼**：

    - 地圖以 5 像素為單位分割為網格，編碼為 0（空）、1（可穿越平台）、2（牆壁）、3（不可穿越平台）。Map 類載入地圖資料並提供查詢介面，支援高效碰撞檢測。

4. **碰撞系統**：

    - 使用 AABB 演算法計算物件邊界框重疊，支援多種類型交互（如玩家與敵人、雪球與牆壁）。
    - 採用空間分割技術，將地圖分為網格僅檢查附近圖塊，優化效能。

5. **統一物件管理**：

    - GameWorld 維護動態物件清單，透過 AddObject 與 RemoveObject 方法管理生命週期。所有物件在每幀統一更新，確保邏輯一致並減少記憶體分配。

6. **雪球與敵人關係**：

    - 敵人被擊中後生成 Snowball 物件，敵人隱藏並同步位置至雪球。雪球管理推、踢、滾動與融化邏輯，銷毀或融化後觸發敵人恢復或移除，實現模組化設計。

7. **工廠模式 (Factory Pattern)**：

    - 關卡系統使用工廠模式，根據配置表動態生成敵人實例（如 RedDemon、Boss）。SpawnEnemiesForLevel 方法透過條件判斷創建對應敵人，支援新敵人類型擴展。

8. **記憶體管理**：

    - 使用智慧指標（如 std::shared_ptr）管理物件生命週期，確保資源正確釋放。透過 tracemalloc 等工具追蹤記憶體使用，解決潛在洩漏問題。

9. **回呼函式 (Callback Functions)**：

    - 玩家與敵人的碰撞事件透過回呼機制處理，例如 Nick 的 OnCollision 方法通知死亡邏輯，降低類別間耦合。

10. **美術處理工具**：
    - 開發一些簡易圖片處理程式，部署於 GitHub Pages（https://t112590055.github.io），支援以下功能：
        - **圖片網格編碼**：將地圖圖片分割為 5 像素網格，生成編碼檔案（0、1、2、3），用於地圖載入。
        - **圖片物件分割去背**：分割角色與敵人圖片，移除背景生成透明 PNG。
        - **色彩格式轉換**：將圖片轉換為遊戲支援的色彩格式。

## 結語

### 問題與解決方法

1. **問題**：協同開發過程中，因 Git merge 衝突導致版本整合耗時。  
   **解決**：let it go.
2. **問題**：智慧指標（std::shared_ptr 與 std::weak_ptr）的使用導致物件生命週期管理複雜，出現意外的物件保留或提早銷毀。  
   **解決**：透過仔細追蹤物件引用，明確定義智慧指標的擁有關係，並使用 std::weak_ptr 避免循環引用，確保穩定性。

### 自評

| 項次 | 項目                                     | 完成 |
| ---- | ---------------------------------------- | ---- |
| 1    | 完成專案權限改為 public                  | V    |
| 2    | 具有 debug mode 的功能                   | V    |
| 3    | 解決專案上所有 Memory Leak 的問題        | V    |
| 4    | 報告中沒有任何錯字，以及沒有任何一項遺漏 | V    |
| 5    | 報告至少保持基本的美感，人類可讀         | V    |
| 6    | 遊戲可玩                                 | V    |
| 7    | 程式能跑                                 | V    |

### 心得

-   **張家程**：本專案讓我深入理解 OOP 在遊戲開發中的應用。👌
-   **彭瑜祐**：本專案讓我深入理解 OOP 在遊戲開發中的應用。👍

### 貢獻比例

-   張家程：50%
-   彭瑜祐：50%

[![Ask DeepWiki](https://deepwiki.com/badge.svg)](https://deepwiki.com/WalkingMen666/SnowBros)
